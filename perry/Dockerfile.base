# syntax=docker/dockerfile:1
# Perry Base Image
# Minimal image with Perry runtime, coding agents, and essential tools.
# Users can extend this with their own language runtimes and tools.

# Stage 1: Build Neovim from source
FROM ubuntu:noble AS neovim-builder

ENV DEBIAN_FRONTEND=noninteractive

RUN apt-get update && apt-get install -y --no-install-recommends \
    git \
    ninja-build \
    gettext \
    cmake \
    build-essential \
    curl \
    ca-certificates \
  && rm -rf /var/lib/apt/lists/*

RUN git clone --depth 1 --branch v0.11.4 https://github.com/neovim/neovim.git /tmp/neovim \
  && cd /tmp/neovim \
  && make CMAKE_BUILD_TYPE=RelWithDebInfo CMAKE_INSTALL_PREFIX=/usr/local \
  && make install \
  && rm -rf /tmp/neovim

# Stage 2: Final image
FROM ubuntu:noble

ENV DEBIAN_FRONTEND=noninteractive

# Install prerequisites for adding Docker repository
RUN apt-get update && apt-get install -y --no-install-recommends \
    ca-certificates \
    curl \
    gnupg \
    lsb-release \
  && rm -rf /var/lib/apt/lists/*

# Add Docker's official GPG key and repository
RUN install -m 0755 -d /etc/apt/keyrings \
  && curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc \
  && chmod a+r /etc/apt/keyrings/docker.asc \
  && echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu \
  $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null

# Install Docker Engine, CLI, and essential tools
RUN apt-get update && apt-get install -y --no-install-recommends \
    docker-ce \
    docker-ce-cli \
    containerd.io \
    docker-buildx-plugin \
    docker-compose-plugin \
    bash \
    sudo \
    openssh-server \
    git \
    curl \
    tzdata \
    jq \
    rsync \
    unzip \
    zip \
    less \
    iproute2 \
    iptables \
    kmod \
    openssl \
    procps \
    ripgrep \
    fd-find \
    fzf \
  && rm -rf /var/lib/apt/lists/*

# Copy Neovim from builder stage
COPY --from=neovim-builder /usr/local/bin/nvim /usr/local/bin/nvim
COPY --from=neovim-builder /usr/local/lib/nvim /usr/local/lib/nvim
COPY --from=neovim-builder /usr/local/share/nvim /usr/local/share/nvim

# Install GitHub CLI
RUN curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg -o /usr/share/keyrings/githubcli-archive-keyring.gpg \
  && chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg \
  && echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | tee /etc/apt/sources.list.d/github-cli.list > /dev/null \
  && apt-get update \
  && apt-get install -y gh \
  && rm -rf /var/lib/apt/lists/* \
  && gh --version

# Install docker-init (tini) for proper process management
RUN curl -fsSL https://github.com/krallin/tini/releases/download/v0.19.0/tini-static-$(dpkg --print-architecture) -o /usr/local/bin/docker-init \
  && chmod +x /usr/local/bin/docker-init

# Set up iptables-legacy for compatibility
RUN update-alternatives --set iptables /usr/sbin/iptables-legacy || true \
  && update-alternatives --set ip6tables /usr/sbin/ip6tables-legacy || true

# Create legacy iptables directory structure for dockerd-entrypoint.sh compatibility
RUN mkdir -p /usr/local/sbin/.iptables-legacy \
  && ln -s /usr/sbin/iptables-legacy /usr/local/sbin/.iptables-legacy/iptables \
  && ln -s /usr/sbin/ip6tables-legacy /usr/local/sbin/.iptables-legacy/ip6tables

RUN ln -sf /usr/share/zoneinfo/UTC /etc/localtime \
  && echo "UTC" > /etc/timezone

RUN mkdir -p /run/sshd \
  && ssh-keygen -A \
  && sed -i 's/#\?PermitRootLogin.*/PermitRootLogin prohibit-password/' /etc/ssh/sshd_config \
  && sed -i 's/#\?PasswordAuthentication.*/PasswordAuthentication yes/' /etc/ssh/sshd_config \
  && sed -i 's/#\?AllowTcpForwarding.*/AllowTcpForwarding yes/' /etc/ssh/sshd_config \
  && sed -i 's/#\?AllowAgentForwarding.*/AllowAgentForwarding yes/' /etc/ssh/sshd_config \
  && sed -i 's/#\?GatewayPorts.*/GatewayPorts clientspecified/' /etc/ssh/sshd_config \
  && echo 'SetEnv PATH=/home/workspace/.npm-global/bin:/home/workspace/.local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin' >> /etc/ssh/sshd_config

# Install Node.js (needed for npm global packages like codex)
RUN curl -fsSL https://deb.nodesource.com/setup_22.x | bash - \
  && apt-get install -y nodejs \
  && rm -rf /var/lib/apt/lists/* \
  && node --version \
  && npm --version

# Install Bun
ENV BUN_INSTALL=/usr/local
RUN bash -lc "curl -fsSL https://bun.sh/install | bash" \
  && bun --version

# Create workspace user with passwordless sudo
RUN useradd -m -s /bin/bash workspace \
  && echo "workspace:workspace" | chpasswd \
  && usermod -aG sudo workspace \
  && usermod -aG docker workspace \
  && echo "%sudo ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

# Configure npm to use user-writable global directory
USER workspace
RUN mkdir -p /home/workspace/.npm-global \
  && npm config set prefix '/home/workspace/.npm-global'

USER root
ENV PATH="/home/workspace/.npm-global/bin:/root/.local/bin:/home/workspace/.local/bin:${PATH}"

# Enable BuildKit for docker build and docker compose
ENV DOCKER_BUILDKIT=1
ENV COMPOSE_DOCKER_CLI_BUILD=1

# Install coding agents as workspace user
USER workspace

RUN curl -fsSL https://claude.ai/install.sh | bash

RUN curl -fsSL https://opencode.ai/install | bash || echo "OpenCode install failed; will retry on workspace start"

USER root

# Install Tailscale
RUN curl -fsSL https://tailscale.com/install.sh | sh

ENV PATH="/home/workspace/.opencode/bin:${PATH}"

RUN mkdir -p /home/workspace /workspace/config /workspace/template /workspace/source \
  && chown -R workspace:workspace /home/workspace /workspace

# Copy Perry internal scripts
COPY scripts /opt/workspace/scripts
COPY internal/package.json /opt/workspace/internal/package.json
RUN cd /opt/workspace/internal && bun install --production
COPY internal /opt/workspace/internal
RUN chmod +x /opt/workspace/scripts/dockerd-entrypoint.sh \
  && install -m 0755 /opt/workspace/scripts/dockerd-entrypoint.sh /usr/local/bin/dockerd-entrypoint.sh \
  && chmod +x /opt/workspace/internal/src/index.ts \
  && printf '#!/bin/sh\nexec bun /opt/workspace/internal/src/index.ts "$@"\n' > /usr/local/bin/workspace-internal \
  && chmod +x /usr/local/bin/workspace-internal

USER root
WORKDIR /home/workspace

EXPOSE 22 2376

ENTRYPOINT ["/usr/local/bin/workspace-internal", "entrypoint"]
